import React, { useEffect, useState, useRef } from "react";
import { Link } from "react-router-dom";
import { onAuthStateChanged } from "firebase/auth";
import { doc, getDoc } from "firebase/firestore";
import { auth, db } from "../firebaseConfig";
import FitFusionLogo from "./FitFusionLogo";
import { generateAIResponse } from "../services/aiCoachService";

type Role = "user" | "assistant" | "system";

interface Message {
  role: Role;
  content: string;
  timestamp: Date;
}

interface QuickPrompt {
  icon: string;
  title: string;
  prompt: string;
}

const AiCoach: React.FC = () => {
  const [messages, setMessages] = useState<Message[]>([]);
  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [thinking, setThinking] = useState(false);
  const [error, setError] = useState("");
  const [userName, setUserName] = useState<string>("");
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLInputElement>(null);

  // Comprehensive user context from Firebase and localStorage
  const [userCtx, setUserCtx] = useState<{
    displayName?: string;
    email?: string;
    goal?: string;
    height?: string;
    currentWeight?: string;
    targetWeight?: string;
    gender?: string;
    age?: number;
    // Activity data
    todaySteps?: number;
    todayCalories?: number;
    todayActiveMinutes?: number;
    todayHydration?: number;
    todayWorkouts?: number;
    streak?: number;
    // Historical data
    weeklyAvgSteps?: number;
    weeklyWorkouts?: number;
    totalWorkouts?: number;
    memberSince?: string;
  } | null>(null);

  const quickPrompts: QuickPrompt[] = [
    { icon: "üí™", title: "Workout Plan", prompt: "Create a beginner-friendly workout plan for me" },
    { icon: "ü•ó", title: "Meal Ideas", prompt: "Suggest healthy meal ideas for weight loss" },
    { icon: "üéØ", title: "Set Goals", prompt: "Help me set realistic fitness goals" },
    { icon: "üìä", title: "Track Progress", prompt: "How should I track my fitness progress?" },
  ];

  useEffect(() => {
    const unsub = onAuthStateChanged(auth, async (u) => {
      if (!u) { 
        setUserCtx(null); 
        setUserName('');
        return; 
      }
      try {
        const snap = await getDoc(doc(db, "users", u.uid));
        const data = snap.exists() ? (snap.data() as any) : {};
        
        // Get activity data from localStorage (simulating real-time tracking)
        const activityData = JSON.parse(localStorage.getItem('fitfusion_activity') || '{}');
        const userActivityKey = `user_${u.uid}`;
        const userActivity = activityData[userActivityKey] || {};
        
        // Calculate age from DOB
        let age = undefined;
        if (data?.dob) {
          const birthDate = new Date(data.dob);
          const today = new Date();
          age = today.getFullYear() - birthDate.getFullYear();
          const monthDiff = today.getMonth() - birthDate.getMonth();
          if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
            age--;
          }
        }

        // Calculate member duration
        let memberSince = "recently";
        if (data?.createdAt) {
          const created = data.createdAt.toDate ? data.createdAt.toDate() : new Date(data.createdAt);
          const daysSince = Math.floor((new Date().getTime() - created.getTime()) / (1000 * 60 * 60 * 24));
          if (daysSince < 7) memberSince = `${daysSince} days ago`;
          else if (daysSince < 30) memberSince = `${Math.floor(daysSince / 7)} weeks ago`;
          else if (daysSince < 365) memberSince = `${Math.floor(daysSince / 30)} months ago`;
          else memberSince = `${Math.floor(daysSince / 365)} years ago`;
        }
        
        const ctx = {
          displayName: data?.displayName || u.displayName || (u.email?.split("@")[0] ?? ""),
          email: u.email || "",
          goal: data?.goals?.primary || "",
          height: data?.metrics?.height || "",
          currentWeight: data?.metrics?.currentWeight || "",
          targetWeight: data?.metrics?.targetWeight || "",
          gender: data?.gender || "",
          age,
          // Today's activity
          todaySteps: userActivity.steps || 0,
          todayCalories: userActivity.calories || 0,
          todayActiveMinutes: userActivity.activeMinutes || 0,
          todayHydration: userActivity.hydration || 0,
          todayWorkouts: userActivity.workoutsCompleted || 0,
          streak: userActivity.streak || 1,
          // Historical data
          weeklyAvgSteps: userActivity.weeklyAvgSteps || 0,
          weeklyWorkouts: userActivity.weeklyWorkouts || 0,
          totalWorkouts: userActivity.totalWorkouts || 0,
          memberSince,
        };
        setUserCtx(ctx);
        setUserName(ctx.displayName || '');
      } catch (err) {
        console.error("Error loading user context:", err);
        const fallback = u.displayName || (u.email?.split("@")[0] ?? "");
        setUserCtx({ displayName: fallback, email: u.email || "" });
        setUserName(fallback);
      }
    });
    return () => unsub();
  }, []);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  const sendMessage = async (messageText?: string) => {
    const text = (messageText || input).trim();
    if (!text || loading) return;
    setError("");

    // Build a comprehensive, context-aware system prompt
    const sysBase = `You are Fit Fusion AI Coach - a world-class fitness and nutrition expert with the conversational ability of ChatGPT, combined with deep expertise in exercise science, nutrition, behavioral psychology, and personalized coaching.

CORE IDENTITY:
You are warm, knowledgeable, and genuinely invested in helping users achieve their fitness goals. You understand that fitness is a journey, not a destination, and you meet users where they are with empathy and expertise.

RESPONSE PHILOSOPHY:
1. UNDERSTAND FIRST: Carefully analyze what the user is really asking
2. PERSONALIZE: Use their actual data, name, and context naturally
3. EDUCATE: Explain the "why" behind your recommendations
4. ACTIONABLE: Provide clear, specific next steps
5. MOTIVATE: Encourage without being preachy
6. FOLLOW-UP: Suggest related topics or ask clarifying questions

COMMUNICATION STYLE (Like ChatGPT):
- Natural, conversational tone - talk like a knowledgeable friend
- Use their name organically (not in every sentence)
- Break down complex topics into digestible pieces
- Use analogies and examples to clarify concepts
- Acknowledge uncertainty when appropriate
- Ask clarifying questions to better help
- Adapt your language to match their question style
- Use emojis sparingly and purposefully
- Format for readability: headers, bullets, spacing

EXPERTISE DOMAINS:
üèãÔ∏è TRAINING: Strength, hypertrophy, endurance, HIIT, flexibility, mobility, sport-specific
ü•ó NUTRITION: Macros, meal timing, supplements, diets (keto, IF, etc), meal prep
üìä PROGRESS: Tracking methods, analytics, plateau breaking, body composition
üéØ GOALS: Weight loss, muscle gain, recomp, performance, health markers
üß† PSYCHOLOGY: Motivation, habit formation, consistency, overcoming barriers
üí™ RECOVERY: Sleep, rest days, active recovery, injury prevention, stress management
üìê SCIENCE: Exercise physiology, nutrition science, evidence-based practices

RESPONSE STRUCTURE:
1. Acknowledge their question/situation
2. Reference relevant personal data if applicable
3. Provide comprehensive answer with reasoning
4. Give specific, actionable recommendations
5. Offer encouragement or next steps
6. Invite follow-up questions

CRITICAL RULES:
‚úì Answer the ACTUAL question asked (don't go off-topic)
‚úì Use their real data (steps, workouts, goals, etc.) when relevant
‚úì Provide specific numbers (reps, sets, calories, timing)
‚úì Explain WHY, not just WHAT
‚úì Be realistic about timelines and expectations
‚úì Prioritize safety and sustainable practices
‚úì Celebrate their wins and progress
‚úì Adapt advice to their fitness level and goal
‚úì If you don't have enough info, ask for it
‚úì Keep responses focused and well-organized

NEVER:
‚úó Give generic, cookie-cutter responses
‚úó Ignore the user's context and data
‚úó Recommend unsafe or extreme practices
‚úó Make unrealistic promises
‚úó Be condescending or judgmental
‚úó Provide medical diagnoses (suggest doctor visits)
‚úó Ramble or go off-topic
‚úó Use overly technical jargon without explanation`;

    // Build comprehensive user context
    let ctxLine = "";
    if (userCtx) {
      const profileParts = [
        `üë§ USER PROFILE:`,
        `Name: ${userCtx.displayName || "User"}`,
        userCtx.age ? `Age: ${userCtx.age} years` : null,
        userCtx.gender ? `Gender: ${userCtx.gender}` : null,
        userCtx.memberSince ? `Member since: ${userCtx.memberSince}` : null,
      ].filter(Boolean);

      const goalsParts = [
        `\nüéØ FITNESS GOALS:`,
        userCtx.goal ? `Primary Goal: ${userCtx.goal}` : "Primary Goal: Not specified",
        userCtx.currentWeight ? `Current Weight: ${userCtx.currentWeight} kg` : null,
        userCtx.targetWeight ? `Target Weight: ${userCtx.targetWeight} kg` : null,
        userCtx.height ? `Height: ${userCtx.height} cm` : null,
      ].filter(Boolean);

      const activityParts = [
        `\nüìä TODAY'S ACTIVITY:`,
        `Steps: ${userCtx.todaySteps?.toLocaleString() || 0} (Goal: 10,000)`,
        `Active Minutes: ${userCtx.todayActiveMinutes || 0} min (Goal: 60)`,
        `Calories Burned: ${userCtx.todayCalories?.toLocaleString() || 0} cal`,
        `Water Intake: ${userCtx.todayHydration || 0}/8 glasses`,
        `Workouts Completed: ${userCtx.todayWorkouts || 0}`,
        `Current Streak: ${userCtx.streak || 1} days üî•`,
      ];

      const progressParts = [
        `\nüìà PROGRESS SUMMARY:`,
        userCtx.weeklyAvgSteps ? `Weekly Avg Steps: ${userCtx.weeklyAvgSteps.toLocaleString()}` : null,
        userCtx.weeklyWorkouts ? `Workouts This Week: ${userCtx.weeklyWorkouts}` : null,
        userCtx.totalWorkouts ? `Total Workouts: ${userCtx.totalWorkouts}` : null,
      ].filter(Boolean);

      ctxLine = [
        ...profileParts,
        ...goalsParts,
        ...activityParts,
        ...(progressParts.length > 1 ? progressParts : []),
      ].join("\n");
    }

    const systemMessage: Message = { 
      role: "system", 
      content: [sysBase, ctxLine].filter(Boolean).join("\n\n"),
      timestamp: new Date()
    };

    const userMessage: Message = { 
      role: "user", 
      content: text,
      timestamp: new Date()
    };

    const hadSystem = messages.some(m => m.role === "system");
    const nextMessages: Message[] = hadSystem
      ? [...messages, userMessage]
      : [systemMessage, ...messages, userMessage];
    
    setMessages(nextMessages);
    setInput("");
    setThinking(true);

    // Simulate thinking time (2-3 seconds) with heart logo beating
    const thinkingTime = 2000 + Math.random() * 1000; // 2-3 seconds
    await new Promise(resolve => setTimeout(resolve, thinkingTime));
    
    setThinking(false);
    setLoading(true);

    try {
      const tryOnce = async (url: string) => {
        const controller = new AbortController();
        const t = setTimeout(() => controller.abort(), 30000); // 30s timeout
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            messages: nextMessages.map(m => ({ role: m.role, content: m.content }))
          }),
          signal: controller.signal
        }).finally(() => clearTimeout(t));
        
        const ct = res.headers.get("content-type") || "";
        if (!ct.includes("application/json")) {
          const txt = await res.text();
          throw new Error(txt.slice(0, 120) || "Non-JSON response");
        }
        const data = await res.json();
        if (!res.ok || !data?.message) {
          throw new Error(data?.error || "Unexpected response");
        }
        return data.message as string;
      };

      let reply: string = "";
      try {
        reply = await tryOnce("/api/chatbot/message");
      } catch (err1) {
        try {
          reply = await tryOnce("http://localhost:5000/api/chatbot/message");
        } catch (err2) {
          // Fallback to intelligent AI response
          reply = generateAIResponse({
            userMessage: text,
            userCtx: userCtx,
            conversationHistory: messages.filter(m => m.role !== 'system').map(m => ({ role: m.role, content: m.content }))
          });
        }
      }

      setMessages((prev) => [...prev, { 
        role: "assistant", 
        content: reply,
        timestamp: new Date()
      }]);
    } catch (e: any) {
      const errorMsg = e?.message || "Error contacting AI Coach.";
      setError(errorMsg);
      setMessages((prev) => [...prev, { 
        role: "assistant", 
        content: "I apologize, but I'm having trouble connecting right now. Please try again in a moment.",
        timestamp: new Date()
      }]);
    } finally {
      setLoading(false);
    }
  };

  // Old generateMockResponse function removed - now using aiCoachService.ts
    const lower = userMessage.toLowerCase();
    const name = userCtx?.displayName || "there";
    const goal = userCtx?.goal || "your fitness goals";
    const steps = userCtx?.todaySteps || 0;
    const workouts = userCtx?.todayWorkouts || 0;
    const streak = userCtx?.streak || 1;
    const hydration = userCtx?.todayHydration || 0;
    const activeMinutes = userCtx?.todayActiveMinutes || 0;
    const calories = userCtx?.todayCalories || 0;
    
    // Nutrition/diet request - HIGH PRIORITY
    if (lower.includes("meal") || lower.includes("diet") || lower.includes("nutrition") || 
        lower.includes("food") || lower.includes("eat") || lower.includes("recipe") ||
        lower.includes("breakfast") || lower.includes("lunch") || lower.includes("dinner") ||
        lower.includes("snack") || lower.match(/what.*eat/) || lower.match(/what.*try/)) {
      
      let response = `Great question, ${name}! Let me create a personalized nutrition plan for you ü•ó\n\n`;
      
      // Calculate basic calorie needs
      const weight = parseFloat(userCtx?.currentWeight || "70");
      const targetWeight = parseFloat(userCtx?.targetWeight || "65");
      const isWeightLoss = weight > targetWeight;
      
      let dailyCalories = 2000;
      if (isWeightLoss) {
        dailyCalories = Math.round(weight * 24 - 500);
      } else {
        dailyCalories = Math.round(weight * 28 + 300);
      }
      
      response += `**üìä Your Daily Nutrition Targets:**\n`;
      response += `‚Ä¢ Calories: ${dailyCalories} cal ${isWeightLoss ? '(deficit for fat loss)' : '(surplus for muscle gain)'}\n`;
      response += `‚Ä¢ Protein: ${Math.round(weight * 2)}g (builds muscle, keeps you full)\n`;
      response += `‚Ä¢ Carbs: ${Math.round(dailyCalories * 0.40 / 4)}g (energy for workouts)\n`;
      response += `‚Ä¢ Fats: ${Math.round(dailyCalories * 0.30 / 9)}g (hormone health)\n`;
      response += `‚Ä¢ Water: 8+ glasses üíß\n\n`;
      
      response += `**üç≥ Today's Meal Plan:**\n\n`;
      
      response += `**Breakfast (${Math.round(dailyCalories * 0.25)} cal) - 7:00 AM**\n`;
      response += `‚Ä¢ 3 egg whites + 1 whole egg scrambled\n`;
      response += `‚Ä¢ 1 cup oatmeal with berries\n`;
      response += `‚Ä¢ 1 tbsp almond butter\n`;
      response += `‚Ä¢ Green tea or black coffee\n`;
      response += `üí° *High protein start to boost metabolism*\n\n`;
      
      response += `**Mid-Morning Snack (${Math.round(dailyCalories * 0.10)} cal) - 10:30 AM**\n`;
      response += `‚Ä¢ Greek yogurt (150g) with honey\n`;
      response += `‚Ä¢ Handful of almonds (10-12)\n`;
      response += `‚Ä¢ Apple or banana\n`;
      response += `üí° *Keeps energy stable until lunch*\n\n`;
      
      response += `**Lunch (${Math.round(dailyCalories * 0.35)} cal) - 1:00 PM**\n`;
      response += `‚Ä¢ Grilled chicken breast (150g)\n`;
      response += `‚Ä¢ Quinoa or brown rice (1 cup cooked)\n`;
      response += `‚Ä¢ Mixed vegetables (broccoli, carrots, peppers)\n`;
      response += `‚Ä¢ Side salad with olive oil dressing\n`;
      response += `üí° *Balanced macros for sustained energy*\n\n`;
      
      response += `**Afternoon Snack (${Math.round(dailyCalories * 0.10)} cal) - 4:00 PM**\n`;
      response += `‚Ä¢ Protein shake (whey or plant-based)\n`;
      response += `‚Ä¢ Rice cakes with peanut butter\n`;
      response += `‚Ä¢ Orange or berries\n`;
      response += `üí° *Pre-workout fuel if exercising*\n\n`;
      
      response += `**Dinner (${Math.round(dailyCalories * 0.30)} cal) - 7:00 PM**\n`;
      response += `‚Ä¢ Baked salmon or lean beef (150g)\n`;
      response += `‚Ä¢ Sweet potato (medium, baked)\n`;
      response += `‚Ä¢ Steamed broccoli and asparagus\n`;
      response += `‚Ä¢ Small side salad\n`;
      response += `üí° *Lighter carbs in evening for better sleep*\n\n`;
      
      response += `**üåü Pro Tips for Success:**\n`;
      response += `‚úì Meal prep on Sundays for the week\n`;
      response += `‚úì Drink water 30 min before each meal\n`;
      response += `‚úì Eat protein with every meal\n`;
      response += `‚úì Avoid processed foods and sugar\n`;
      response += `‚úì Track your meals in the app\n`;
      response += `‚úì Eat slowly and mindfully\n\n`;
      
      if (hydration < 8) {
        response += `‚ö†Ô∏è **Important:** You've only had ${hydration}/8 glasses of water today. Drink more water to support ${goal}!\n\n`;
      }
      
      response += `**üéØ This Week's Challenge:**\n`;
      response += `Try this meal plan for 3 days and track how you feel. Notice your energy levels, hunger, and workout performance!\n\n`;
      response += `Need specific recipes or have dietary restrictions? Just ask! üçΩÔ∏è`;
      
      return response;
    }
    
    // Workout request - HIGH PRIORITY
    if (lower.includes("workout") || lower.includes("exercise") || lower.includes("training") || 
        lower.includes("gym") || (lower.match(/what.*do/) && (lower.includes("fitness") || lower.includes("body")))) {
      
      let response = `Perfect timing, ${name}! Let me create a workout plan for you based on your goal: ${goal} üí™\n\n`;
      
      if (workouts > 0) {
        response += `I see you've already completed ${workouts} workout${workouts > 1 ? 's' : ''} today! That's awesome! Here's something to complement that:\n\n`;
      }
      
      const isWeightLoss = goal.toLowerCase().includes("weight loss") || goal.toLowerCase().includes("lose weight") || goal.toLowerCase().includes("fat");
      const isMuscle = goal.toLowerCase().includes("muscle") || goal.toLowerCase().includes("strength") || goal.toLowerCase().includes("gain");
      
      if (isWeightLoss) {
        response += `**üî• Fat-Burning HIIT Circuit** (25 minutes)\n\n`;
        response += `**Warm-up (5 min):**\n`;
        response += `‚Ä¢ Jumping jacks: 1 min\n`;
        response += `‚Ä¢ Arm circles: 1 min\n`;
        response += `‚Ä¢ High knees: 1 min\n`;
        response += `‚Ä¢ Butt kicks: 1 min\n`;
        response += `‚Ä¢ Dynamic stretches: 1 min\n\n`;
        response += `**Main Circuit (3 rounds, 45 sec work / 15 sec rest):**\n`;
        response += `1. Burpees - Full body cardio blast\n`;
        response += `2. Mountain climbers - Core + cardio\n`;
        response += `3. Jump squats - Lower body power\n`;
        response += `4. Push-ups - Upper body strength\n`;
        response += `5. High knees - Cardio intensity\n`;
        response += `6. Plank - Core stability\n\n`;
        response += `**Cool-down (5 min):** Light stretching\n\n`;
        response += `üí° **This will burn approximately 250-350 calories!**\n`;
      } else if (isMuscle) {
        response += `**üí™ Strength Building Workout** (40 minutes)\n\n`;
        response += `**Upper Body Focus:**\n`;
        response += `‚Ä¢ Push-ups: 4 sets √ó 12 reps (90 sec rest)\n`;
        response += `‚Ä¢ Dumbbell rows: 4 sets √ó 10 reps each arm\n`;
        response += `‚Ä¢ Shoulder press: 3 sets √ó 12 reps\n`;
        response += `‚Ä¢ Bicep curls: 3 sets √ó 15 reps\n`;
        response += `‚Ä¢ Tricep dips: 3 sets √ó 12 reps\n\n`;
        response += `**Core Finisher:**\n`;
        response += `‚Ä¢ Plank: 3 sets √ó 45 seconds\n`;
        response += `‚Ä¢ Russian twists: 3 sets √ó 20 reps\n`;
        response += `‚Ä¢ Leg raises: 3 sets √ó 15 reps\n\n`;
        response += `üí° **Focus on form over speed. Control the movement!**\n`;
      } else {
        response += `**üéØ Balanced Full-Body Workout** (30 minutes)\n\n`;
        response += `**Circuit (4 rounds):**\n`;
        response += `‚Ä¢ Squats: 15 reps\n`;
        response += `‚Ä¢ Push-ups: 12 reps\n`;
        response += `‚Ä¢ Lunges: 10 reps each leg\n`;
        response += `‚Ä¢ Plank: 30 seconds\n`;
        response += `‚Ä¢ Jumping jacks: 30 seconds\n`;
        response += `Rest 60 seconds between rounds\n\n`;
        response += `üí° **This hits all major muscle groups efficiently!**\n`;
      }
      
      response += `\n‚úÖ **After completing this:**\n`;
      response += `‚Ä¢ You'll add ~30-40 active minutes\n`;
      response += `‚Ä¢ Burn 200-400 calories\n`;
      response += `‚Ä¢ Maintain your ${streak}-day streak!\n\n`;
      response += `Ready to crush it? Let me know how it goes! üí™`;
      
      return response;
    }
    
    // Steps inquiry
    if ((lower.includes("step") && !lower.includes("diet")) || lower.includes("walk") || lower.includes("covered")) {
      let response = `Great question, ${name}! Let me check your step count üëü\n\n`;
      
      response += `**üìä Today's Steps: ${steps.toLocaleString()}**\n\n`;
      
      if (steps >= 10000) {
        response += `üéâ **Fantastic!** You've crushed your daily goal of 10,000 steps!\n\n`;
        response += `That's approximately:\n`;
        response += `‚Ä¢ ${(steps * 0.0008).toFixed(1)} km distance covered\n`;
        response += `‚Ä¢ ${Math.round(steps * 0.04)} calories burned from walking\n`;
        response += `‚Ä¢ ${Math.round(steps / 100)} minutes of activity\n\n`;
        response += `You're in the top tier of active people! Keep this momentum going! üí™`;
      } else if (steps >= 7500) {
        response += `üëç **Great progress!** You're at ${Math.round((steps / 10000) * 100)}% of your 10,000 step goal.\n\n`;
        response += `Just ${(10000 - steps).toLocaleString()} more steps to go!\n\n`;
        response += `**Quick ways to hit your goal:**\n`;
        response += `‚Ä¢ Take a ${Math.ceil((10000 - steps) / 100)}-minute walk\n`;
        response += `‚Ä¢ Walk around while on phone calls\n`;
        response += `‚Ä¢ Take the stairs instead of elevator\n`;
        response += `‚Ä¢ Park farther from your destination\n\n`;
        response += `You've got this! üö∂‚Äç‚ôÇÔ∏è`;
      } else if (steps >= 5000) {
        response += `üí™ **Good start!** You're halfway to your goal.\n\n`;
        response += `**Current stats:**\n`;
        response += `‚Ä¢ Distance: ${(steps * 0.0008).toFixed(1)} km\n`;
        response += `‚Ä¢ Calories: ~${Math.round(steps * 0.04)} cal\n`;
        response += `‚Ä¢ Remaining: ${(10000 - steps).toLocaleString()} steps\n\n`;
        response += `**Challenge:** Can you add 2,500 more steps before lunch? That's just a 25-minute walk! üéØ`;
      } else if (steps > 0) {
        response += `You've taken ${steps.toLocaleString()} steps so far today.\n\n`;
        response += `**Let's get moving!** Here's your action plan:\n\n`;
        response += `üéØ **Goal:** 10,000 steps (${(10000 - steps).toLocaleString()} to go)\n\n`;
        response += `**Easy ways to add steps:**\n`;
        response += `1. 30-minute walk = ~3,000 steps\n`;
        response += `2. 15-minute walk = ~1,500 steps\n`;
        response += `3. Walk during breaks = ~500 steps each\n`;
        response += `4. Evening stroll = ~2,000 steps\n\n`;
        response += `Every step counts! Start with a quick 10-minute walk right now? üö∂‚Äç‚ôÄÔ∏è`;
      } else {
        response += `I don't see any steps logged yet today, ${name}.\n\n`;
        response += `**Let's change that!** üöÄ\n\n`;
        response += `**Your 10,000 Step Plan:**\n`;
        response += `‚Ä¢ Morning walk: 3,000 steps (30 min)\n`;
        response += `‚Ä¢ Lunch break walk: 2,000 steps (20 min)\n`;
        response += `‚Ä¢ Afternoon movement: 2,000 steps\n`;
        response += `‚Ä¢ Evening walk: 3,000 steps (30 min)\n\n`;
        response += `üí° **Pro tip:** Start tracking your steps on the Dashboard! Use the +100 and +1K buttons to log your activity.\n\n`;
        response += `Ready to start? Even a 5-minute walk is a great beginning! üëü`;
      }
      
      return response;
    }
    
    // Greeting responses
    if (lower.match(/^(hi|hello|hey|good morning|good afternoon|good evening)/)) {
      let greeting = `Hey ${name}! üëã Great to see you here!\n\n`;
      
      if (streak > 7) {
        greeting += `üî• Wow! You're on a ${streak}-day streak! That's incredible dedication!\n\n`;
      } else if (streak > 1) {
        greeting += `üî• Nice! You're on a ${streak}-day streak. Keep it going!\n\n`;
      }
      
      if (steps > 0 || workouts > 0) {
        greeting += `üìä **Today's Progress:**\n`;
        if (steps > 0) greeting += `‚Ä¢ ${steps.toLocaleString()} steps ${steps >= 10000 ? '‚úÖ (Goal reached!)' : `(${(10000 - steps).toLocaleString()} to go)`}\n`;
        if (workouts > 0) greeting += `‚Ä¢ ${workouts} workout${workouts > 1 ? 's' : ''} completed üí™\n`;
        if (activeMinutes > 0) greeting += `‚Ä¢ ${activeMinutes} active minutes\n`;
        if (hydration > 0) greeting += `‚Ä¢ ${hydration}/8 glasses of water üíß\n`;
        greeting += `\n`;
      }
      
      greeting += `I'm here to help you with ${goal}. What would you like to work on today?\n\n`;
      greeting += `üí° **I can help with:**\n`;
      greeting += `‚Ä¢ Personalized workout plans\n`;
      greeting += `‚Ä¢ Nutrition and meal planning\n`;
      greeting += `‚Ä¢ Progress analysis and tips\n`;
      greeting += `‚Ä¢ Motivation and accountability`;
      
      return greeting;
    }
    
    // Water/hydration inquiry
    if (lower.includes("water") || lower.includes("hydrat") || lower.includes("drink")) {
      let response = `Let me check your hydration, ${name}! üíß\n\n`;
      
      response += `**Today's Water Intake: ${hydration}/8 glasses**\n\n`;
      
      if (hydration >= 8) {
        response += `üåü **Perfect!** You've hit your daily hydration goal!\n\n`;
        response += `Proper hydration helps with:\n`;
        response += `‚úì Better workout performance\n`;
        response += `‚úì Faster recovery\n`;
        response += `‚úì Improved metabolism\n`;
        response += `‚úì Clearer skin\n`;
        response += `‚úì Better energy levels\n\n`;
        response += `Keep up this excellent habit! üí™`;
      } else if (hydration >= 5) {
        response += `üëç **Good progress!** You're ${hydration} glasses in.\n\n`;
        response += `Just ${8 - hydration} more glass${8 - hydration > 1 ? 'es' : ''} to reach your goal!\n\n`;
        response += `üí° **Tips to finish strong:**\n`;
        response += `‚Ä¢ Set hourly reminders\n`;
        response += `‚Ä¢ Drink a glass before each meal\n`;
        response += `‚Ä¢ Keep water bottle visible\n`;
        response += `‚Ä¢ Add lemon for flavor\n\n`;
        response += `You can do this! üéØ`;
      } else if (hydration > 0) {
        response += `You've had ${hydration} glass${hydration > 1 ? 'es' : ''} so far.\n\n`;
        response += `**Hydration Plan:**\n`;
        response += `‚Ä¢ Now: 1 glass üíß\n`;
        response += `‚Ä¢ Before lunch: 2 glasses\n`;
        response += `‚Ä¢ Afternoon: 2 glasses\n`;
        response += `‚Ä¢ Evening: ${8 - hydration - 5} glass${8 - hydration - 5 !== 1 ? 'es' : ''}\n\n`;
        response += `‚ö†Ô∏è **Remember:** Proper hydration is crucial for ${goal}!\n\n`;
        response += `Drink a glass right now! ü•§`;
      } else {
        response += `I don't see any water logged yet today.\n\n`;
        response += `üíß **Why hydration matters:**\n`;
        response += `‚Ä¢ Boosts metabolism by 30%\n`;
        response += `‚Ä¢ Reduces hunger and cravings\n`;
        response += `‚Ä¢ Improves workout performance\n`;
        response += `‚Ä¢ Aids muscle recovery\n`;
        response += `‚Ä¢ Increases energy levels\n\n`;
        response += `**Your 8-Glass Plan:**\n`;
        response += `‚Ä¢ Wake up: 1 glass\n`;
        response += `‚Ä¢ Before breakfast: 1 glass\n`;
        response += `‚Ä¢ Mid-morning: 1 glass\n`;
        response += `‚Ä¢ Before lunch: 1 glass\n`;
        response += `‚Ä¢ Afternoon: 2 glasses\n`;
        response += `‚Ä¢ Before dinner: 1 glass\n`;
        response += `‚Ä¢ Evening: 1 glass\n\n`;
        response += `Start now! Go to the Dashboard and click the + button to log your water intake! üíß`;
      }
      
      return response;
    }
    
    // Calories inquiry
    if (lower.includes("calorie") || lower.includes("burn")) {
      let response = `Let me check your calorie burn, ${name}! üî•\n\n`;
      
      response += `**Today's Calories Burned: ${calories.toLocaleString()} cal**\n\n`;
      
      if (calories >= 2500) {
        response += `üî• **Incredible!** You're burning serious calories today!\n\n`;
        response += `**Breakdown:**\n`;
        response += `‚Ä¢ From steps: ~${Math.round(steps * 0.04)} cal\n`;
        response += `‚Ä¢ From active minutes: ~${Math.round(activeMinutes * 8)} cal\n`;
        response += `‚Ä¢ Total: ${calories.toLocaleString()} cal\n\n`;
        response += `At this rate, you're creating a great calorie deficit for ${goal}! üí™`;
      } else if (calories >= 1500) {
        response += `üëç **Good work!** You're on track.\n\n`;
        response += `**Ways to burn more:**\n`;
        response += `‚Ä¢ 30-min HIIT: +300 cal\n`;
        response += `‚Ä¢ 1 hour walk: +200 cal\n`;
        response += `‚Ä¢ Strength training: +250 cal\n\n`;
        response += `Want a quick workout to boost your burn? üèãÔ∏è`;
      } else if (calories > 0) {
        response += `You've burned ${calories} calories so far.\n\n`;
        response += `**Quick calorie-burning activities:**\n`;
        response += `‚Ä¢ 20-min jog: 200 cal\n`;
        response += `‚Ä¢ 30-min cycling: 250 cal\n`;
        response += `‚Ä¢ 15-min HIIT: 150 cal\n`;
        response += `‚Ä¢ 1000 steps: 40 cal\n\n`;
        response += `Let's get that number up! üî•`;
      } else {
        response += `No calories burned from activity yet today.\n\n`;
        response += `**Let's change that!** üí™\n\n`;
        response += `Start logging your activities on the Dashboard:\n`;
        response += `‚Ä¢ Add steps to track walking calories\n`;
        response += `‚Ä¢ Log active minutes for workouts\n`;
        response += `‚Ä¢ Complete workouts to boost your burn\n\n`;
        response += `Every movement counts! üöÄ`;
      }
      
      return response;
    }
    
    // Progress/stats inquiry
    if (lower.includes("progress") || lower.includes("how am i doing") || lower.includes("my stats") || lower.includes("how's my") || lower.includes("today")) {
      let response = `Let me analyze your progress, ${name}! üìä\n\n`;
      
      response += `**Today's Performance:**\n`;
      response += `‚Ä¢ Steps: ${steps.toLocaleString()} ${steps >= 10000 ? '‚úÖ' : steps >= 5000 ? 'üü°' : 'üî¥'} (Goal: 10,000)\n`;
      response += `‚Ä¢ Active Minutes: ${activeMinutes} ${activeMinutes >= 60 ? '‚úÖ' : activeMinutes >= 30 ? 'üü°' : 'üî¥'} (Goal: 60)\n`;
      response += `‚Ä¢ Calories Burned: ${calories.toLocaleString()} cal\n`;
      response += `‚Ä¢ Hydration: ${hydration}/8 glasses ${hydration >= 8 ? '‚úÖ' : 'üíß'}\n`;
      response += `‚Ä¢ Workouts: ${workouts} ${workouts > 0 ? 'üí™' : ''}\n`;
      response += `‚Ä¢ Streak: ${streak} days üî•\n\n`;
      
      // Personalized feedback
      if (steps >= 10000 && activeMinutes >= 60 && hydration >= 8) {
        response += `üåü **Outstanding!** You're crushing all your goals today! This is the kind of consistency that leads to real transformation.\n\n`;
      } else if (steps >= 5000 || activeMinutes >= 30) {
        response += `üëç **Good progress!** You're on the right track. Let's push a bit more to hit all your targets.\n\n`;
      } else {
        response += `üí™ **Let's get moving!** You've got plenty of time left today to make progress. Even a 15-minute workout counts!\n\n`;
      }
      
      // Specific recommendations
      response += `**Recommendations:**\n`;
      if (steps < 10000) response += `‚Ä¢ Take a ${Math.ceil((10000 - steps) / 100)} minute walk to hit your step goal\n`;
      if (hydration < 8) response += `‚Ä¢ Drink ${8 - hydration} more glasses of water\n`;
      if (workouts === 0) response += `‚Ä¢ Complete a quick 20-minute workout\n`;
      if (activeMinutes < 60) response += `‚Ä¢ Add ${60 - activeMinutes} more active minutes\n`;
      
      return response;
    }
    
    // Motivation request
    if (lower.includes("motivat") || lower.includes("inspire") || lower.includes("give up") || lower.includes("tired") || lower.includes("hard")) {
      let response = `${name}, I hear you! üí™ Let me remind you why you started:\n\n`;
      
      response += `**üî• Your Journey So Far:**\n`;
      response += `‚Ä¢ You've maintained a ${streak}-day streak\n`;
      if (workouts > 0) response += `‚Ä¢ ${workouts} workout${workouts > 1 ? 's' : ''} completed today\n`;
      if (steps > 5000) response += `‚Ä¢ ${steps.toLocaleString()} steps taken today\n`;
      response += `‚Ä¢ You're working towards: ${goal}\n\n`;
      
      response += `**üíé Remember:**\n`;
      response += `"The only bad workout is the one that didn't happen."\n\n`;
      
      response += `Every single day you show up, you're:\n`;
      response += `‚úì Building discipline\n`;
      response += `‚úì Getting stronger\n`;
      response += `‚úì Closer to your goals\n`;
      response += `‚úì Inspiring others\n\n`;
      
      if (streak > 5) {
        response += `You've already proven you can do this for ${streak} days straight! Don't break that streak now. Future you will thank present you! üôè\n\n`;
      }
      
      response += `**üéØ Small Win Challenge:**\n`;
      response += `Just do ONE of these right now:\n`;
      response += `‚Ä¢ 10 push-ups\n`;
      response += `‚Ä¢ 5-minute walk\n`;
      response += `‚Ä¢ 1 glass of water\n`;
      response += `‚Ä¢ 30-second plank\n\n`;
      response += `That's it. Just one. You've got this! üí™`;
      
      return response;
    }
    
    // Goal setting
    if (lower.includes("goal") || lower.includes("target") || lower.includes("achieve")) {
      let response = `Let's talk goals, ${name}! üéØ\n\n`;
      
      if (userCtx?.goal) {
        response += `I see your current goal is: **${goal}**\n\n`;
        
        if (userCtx.currentWeight && userCtx.targetWeight) {
          const diff = parseFloat(userCtx.currentWeight) - parseFloat(userCtx.targetWeight);
          const weeks = Math.ceil(Math.abs(diff) / 0.5); // 0.5kg per week
          
          response += `**üìä Goal Analysis:**\n`;
          response += `‚Ä¢ Current: ${userCtx.currentWeight} kg\n`;
          response += `‚Ä¢ Target: ${userCtx.targetWeight} kg\n`;
          response += `‚Ä¢ Difference: ${Math.abs(diff).toFixed(1)} kg\n`;
          response += `‚Ä¢ Estimated timeline: ${weeks} weeks (at 0.5kg/week)\n`;
          response += `‚Ä¢ Target date: ${new Date(Date.now() + weeks * 7 * 24 * 60 * 60 * 1000).toLocaleDateString()}\n\n`;
        }
      }
      
      response += `**üéØ SMART Goal Framework:**\n\n`;
      response += `**S**pecific: Define exactly what you want\n`;
      response += `**M**easurable: Track with numbers\n`;
      response += `**A**chievable: Realistic for your lifestyle\n`;
      response += `**R**elevant: Aligned with your values\n`;
      response += `**T**ime-bound: Set a deadline\n\n`;
      
      response += `**üìÖ Recommended Milestones:**\n`;
      response += `‚Ä¢ Week 1-2: Build consistency (3-4 workouts/week)\n`;
      response += `‚Ä¢ Week 3-4: Increase intensity\n`;
      response += `‚Ä¢ Week 5-8: See visible changes\n`;
      response += `‚Ä¢ Week 9-12: Major transformation\n\n`;
      
      response += `**‚úÖ Daily Habits to Focus On:**\n`;
      response += `‚Ä¢ Hit 10,000 steps ${steps >= 10000 ? '‚úÖ' : '‚¨ú'}\n`;
      response += `‚Ä¢ 60 active minutes ${activeMinutes >= 60 ? '‚úÖ' : '‚¨ú'}\n`;
      response += `‚Ä¢ 8 glasses of water ${hydration >= 8 ? '‚úÖ' : '‚¨ú'}\n`;
      response += `‚Ä¢ 1 workout ${workouts > 0 ? '‚úÖ' : '‚¨ú'}\n`;
      response += `‚Ä¢ 7-8 hours sleep ‚¨ú\n\n`;
      
      response += `Keep your ${streak}-day streak alive! Consistency beats perfection! üî•`;
      
      return response;
    }
    
    // Sleep/Rest inquiry
    if (lower.includes("sleep") || lower.includes("rest") || lower.includes("recover")) {
      let response = `Great question about recovery, ${name}! üí§\n\n`;
      
      response += `**üåô Sleep & Recovery Guide:**\n\n`;
      response += `**Optimal Sleep for Fitness:**\n`;
      response += `‚Ä¢ 7-9 hours per night for adults\n`;
      response += `‚Ä¢ Consistent sleep schedule (same time daily)\n`;
      response += `‚Ä¢ Cool, dark room (65-68¬∞F / 18-20¬∞C)\n`;
      response += `‚Ä¢ No screens 1 hour before bed\n\n`;
      
      response += `**Why Sleep Matters:**\n`;
      response += `‚úì Muscle repair and growth\n`;
      response += `‚úì Hormone regulation (testosterone, growth hormone)\n`;
      response += `‚úì Better workout performance\n`;
      response += `‚úì Improved metabolism\n`;
      response += `‚úì Faster recovery\n\n`;
      
      response += `**Recovery Tips:**\n`;
      response += `‚Ä¢ Take 1-2 rest days per week\n`;
      response += `‚Ä¢ Active recovery: light walking, yoga\n`;
      response += `‚Ä¢ Stretch after workouts\n`;
      response += `‚Ä¢ Stay hydrated (${hydration}/8 glasses today)\n`;
      response += `‚Ä¢ Eat protein within 2 hours post-workout\n\n`;
      
      response += `üí° **Pro tip:** Quality sleep can improve workout performance by 20%!`;
      
      return response;
    }
    
    // Supplements inquiry
    if (lower.includes("supplement") || lower.includes("protein powder") || lower.includes("vitamin") || lower.includes("creatine")) {
      let response = `Let me guide you on supplements, ${name}! üíä\n\n`;
      
      response += `**ü•§ Essential Supplements:**\n\n`;
      response += `**1. Protein Powder** (if needed)\n`;
      response += `‚Ä¢ Whey: Fast absorption, post-workout\n`;
      response += `‚Ä¢ Casein: Slow release, before bed\n`;
      response += `‚Ä¢ Plant-based: Pea, rice, hemp blend\n`;
      response += `‚Ä¢ Target: ${Math.round(parseFloat(userCtx?.currentWeight || "70") * 2)}g protein daily\n\n`;
      
      response += `**2. Creatine Monohydrate**\n`;
      response += `‚Ä¢ 5g daily (any time)\n`;
      response += `‚Ä¢ Improves strength and power\n`;
      response += `‚Ä¢ Helps muscle growth\n`;
      response += `‚Ä¢ Safe and well-researched\n\n`;
      
      response += `**3. Multivitamin**\n`;
      response += `‚Ä¢ Fills nutritional gaps\n`;
      response += `‚Ä¢ Take with breakfast\n`;
      response += `‚Ä¢ Choose quality brands\n\n`;
      
      response += `**4. Omega-3 (Fish Oil)**\n`;
      response += `‚Ä¢ Reduces inflammation\n`;
      response += `‚Ä¢ Supports heart health\n`;
      response += `‚Ä¢ 1-2g EPA+DHA daily\n\n`;
      
      response += `**‚ö†Ô∏è Important:**\n`;
      response += `‚Ä¢ Supplements don't replace real food\n`;
      response += `‚Ä¢ Focus on diet first\n`;
      response += `‚Ä¢ Consult doctor before starting\n`;
      response += `‚Ä¢ Buy from reputable brands\n\n`;
      
      response += `üí° **For ${goal}:** Prioritize protein and creatine!`;
      
      return response;
    }
    
    // Injury/Pain inquiry
    if (lower.includes("pain") || lower.includes("hurt") || lower.includes("injury") || lower.includes("sore")) {
      let response = `I'm concerned about your pain, ${name}. Let me help! ü©π\n\n`;
      
      response += `**‚ö†Ô∏è Important First:**\n`;
      response += `If you have severe pain, swelling, or can't move normally, please see a doctor immediately!\n\n`;
      
      response += `**üîç Types of Pain:**\n\n`;
      response += `**Good Pain (Muscle Soreness):**\n`;
      response += `‚Ä¢ Dull, achy feeling\n`;
      response += `‚Ä¢ Appears 24-48 hours after workout\n`;
      response += `‚Ä¢ Symmetrical (both sides)\n`;
      response += `‚Ä¢ Improves with movement\n`;
      response += `‚úì This is normal DOMS (Delayed Onset Muscle Soreness)\n\n`;
      
      response += `**Bad Pain (Injury):**\n`;
      response += `‚Ä¢ Sharp, stabbing sensation\n`;
      response += `‚Ä¢ Immediate during exercise\n`;
      response += `‚Ä¢ One-sided or localized\n`;
      response += `‚Ä¢ Worsens with movement\n`;
      response += `‚ö†Ô∏è Stop exercising and rest!\n\n`;
      
      response += `**Recovery Protocol (RICE):**\n`;
      response += `‚Ä¢ **R**est: Take time off\n`;
      response += `‚Ä¢ **I**ce: 15-20 min, 3-4x daily\n`;
      response += `‚Ä¢ **C**ompression: Wrap affected area\n`;
      response += `‚Ä¢ **E**levation: Raise above heart\n\n`;
      
      response += `**Prevention Tips:**\n`;
      response += `‚úì Always warm up (5-10 min)\n`;
      response += `‚úì Use proper form\n`;
      response += `‚úì Progress gradually\n`;
      response += `‚úì Listen to your body\n`;
      response += `‚úì Get adequate rest\n\n`;
      
      response += `üí° When in doubt, rest and consult a healthcare professional!`;
      
      return response;
    }
    
    // Weight loss specific
    if (lower.includes("lose weight") || lower.includes("weight loss") || lower.includes("fat loss") || lower.includes("slim")) {
      let response = `Let's create your weight loss plan, ${name}! üéØ\n\n`;
      
      const currentWeight = parseFloat(userCtx?.currentWeight || "70");
      const targetWeight = parseFloat(userCtx?.targetWeight || "65");
      const weightToLose = currentWeight - targetWeight;
      
      response += `**üìä Your Weight Loss Journey:**\n`;
      if (userCtx?.currentWeight && userCtx?.targetWeight) {
        response += `‚Ä¢ Current: ${currentWeight} kg\n`;
        response += `‚Ä¢ Target: ${targetWeight} kg\n`;
        response += `‚Ä¢ To Lose: ${weightToLose.toFixed(1)} kg\n`;
        response += `‚Ä¢ Timeline: ${Math.ceil(weightToLose / 0.5)} weeks (0.5kg/week)\n\n`;
      }
      
      response += `**üî• The Formula:**\n`;
      response += `Weight Loss = Calorie Deficit + Exercise + Consistency\n\n`;
      
      response += `**1Ô∏è‚É£ Nutrition (70% of results):**\n`;
      response += `‚Ä¢ Calorie deficit: 500 cal/day\n`;
      response += `‚Ä¢ High protein: ${Math.round(currentWeight * 2)}g daily\n`;
      response += `‚Ä¢ Moderate carbs: Around workouts\n`;
      response += `‚Ä¢ Healthy fats: 20-30% of calories\n`;
      response += `‚Ä¢ Water: 8+ glasses (you're at ${hydration}/8)\n\n`;
      
      response += `**2Ô∏è‚É£ Exercise (30% of results):**\n`;
      response += `‚Ä¢ Cardio: 3-4x per week (30-45 min)\n`;
      response += `‚Ä¢ Strength: 3x per week (preserve muscle)\n`;
      response += `‚Ä¢ Steps: 10,000 daily (you're at ${steps.toLocaleString()})\n`;
      response += `‚Ä¢ NEAT: Stay active throughout day\n\n`;
      
      response += `**3Ô∏è‚É£ Lifestyle:**\n`;
      response += `‚Ä¢ Sleep: 7-9 hours\n`;
      response += `‚Ä¢ Stress: Manage with meditation\n`;
      response += `‚Ä¢ Consistency: 80/20 rule\n`;
      response += `‚Ä¢ Track: Log meals and workouts\n\n`;
      
      response += `**üö´ Avoid:**\n`;
      response += `‚Ä¢ Crash diets (too restrictive)\n`;
      response += `‚Ä¢ Skipping meals\n`;
      response += `‚Ä¢ Only cardio (lose muscle)\n`;
      response += `‚Ä¢ Unrealistic expectations\n\n`;
      
      response += `üí° **Sustainable weight loss:** 0.5-1 kg per week is healthy and maintainable!`;
      
      return response;
    }
    
    // Muscle gain specific
    if (lower.includes("gain muscle") || lower.includes("build muscle") || lower.includes("bulk") || lower.includes("bigger")) {
      let response = `Let's build some muscle, ${name}! üí™\n\n`;
      
      const weight = parseFloat(userCtx?.currentWeight || "70");
      
      response += `**üìä Muscle Building Formula:**\n\n`;
      response += `**1Ô∏è‚É£ Nutrition (Calorie Surplus):**\n`;
      response += `‚Ä¢ Calories: ${Math.round(weight * 28 + 300)} cal/day (+300 surplus)\n`;
      response += `‚Ä¢ Protein: ${Math.round(weight * 2.2)}g daily (CRITICAL!)\n`;
      response += `‚Ä¢ Carbs: ${Math.round((weight * 28 + 300) * 0.45 / 4)}g (fuel for workouts)\n`;
      response += `‚Ä¢ Fats: ${Math.round((weight * 28 + 300) * 0.25 / 9)}g (hormone production)\n`;
      response += `‚Ä¢ Meals: 4-6 per day (every 3-4 hours)\n\n`;
      
      response += `**2Ô∏è‚É£ Training (Progressive Overload):**\n`;
      response += `‚Ä¢ Frequency: 4-5x per week\n`;
      response += `‚Ä¢ Focus: Compound movements\n`;
      response += `  - Squats, Deadlifts, Bench Press\n`;
      response += `  - Pull-ups, Rows, Overhead Press\n`;
      response += `‚Ä¢ Volume: 3-4 sets √ó 8-12 reps\n`;
      response += `‚Ä¢ Rest: 2-3 min between sets\n`;
      response += `‚Ä¢ Progression: Add weight weekly\n\n`;
      
      response += `**3Ô∏è‚É£ Recovery:**\n`;
      response += `‚Ä¢ Sleep: 8-9 hours (muscle grows during sleep)\n`;
      response += `‚Ä¢ Rest days: 2-3 per week\n`;
      response += `‚Ä¢ Hydration: ${hydration}/8 glasses today\n`;
      response += `‚Ä¢ Stretching: Post-workout\n\n`;
      
      response += `**üìÖ Sample Split:**\n`;
      response += `‚Ä¢ Monday: Chest + Triceps\n`;
      response += `‚Ä¢ Tuesday: Back + Biceps\n`;
      response += `‚Ä¢ Wednesday: Rest\n`;
      response += `‚Ä¢ Thursday: Legs\n`;
      response += `‚Ä¢ Friday: Shoulders + Abs\n`;
      response += `‚Ä¢ Weekend: Rest/Active recovery\n\n`;
      
      response += `**üíä Supplements:**\n`;
      response += `‚Ä¢ Protein powder (if needed)\n`;
      response += `‚Ä¢ Creatine: 5g daily\n`;
      response += `‚Ä¢ Multivitamin\n\n`;
      
      response += `üí° **Realistic gains:** 0.5-1 kg muscle per month for beginners!`;
      
      return response;
    }
    
    // Cardio inquiry
    if (lower.includes("cardio") || lower.includes("running") || lower.includes("jogging") || lower.includes("cycling")) {
      let response = `Let's talk cardio, ${name}! üèÉ‚Äç‚ôÇÔ∏è\n\n`;
      
      response += `**üèÉ Types of Cardio:**\n\n`;
      response += `**1. LISS (Low Intensity Steady State)**\n`;
      response += `‚Ä¢ Duration: 30-60 minutes\n`;
      response += `‚Ä¢ Intensity: 60-70% max heart rate\n`;
      response += `‚Ä¢ Examples: Walking, light jogging, cycling\n`;
      response += `‚Ä¢ Best for: Fat burning, recovery\n`;
      response += `‚Ä¢ Frequency: 3-5x per week\n\n`;
      
      response += `**2. HIIT (High Intensity Interval Training)**\n`;
      response += `‚Ä¢ Duration: 15-25 minutes\n`;
      response += `‚Ä¢ Intensity: 80-95% max heart rate\n`;
      response += `‚Ä¢ Format: 30 sec work / 30 sec rest\n`;
      response += `‚Ä¢ Best for: Fat loss, time efficiency\n`;
      response += `‚Ä¢ Frequency: 2-3x per week\n\n`;
      
      response += `**3. MISS (Moderate Intensity)**\n`;
      response += `‚Ä¢ Duration: 20-40 minutes\n`;
      response += `‚Ä¢ Intensity: 70-80% max heart rate\n`;
      response += `‚Ä¢ Examples: Jogging, swimming, rowing\n`;
      response += `‚Ä¢ Best for: Endurance, general fitness\n`;
      response += `‚Ä¢ Frequency: 3-4x per week\n\n`;
      
      response += `**üìä For Your Goal (${goal}):**\n`;
      if (goal.toLowerCase().includes("weight loss") || goal.toLowerCase().includes("fat")) {
        response += `‚Ä¢ HIIT: 2-3x per week (max fat burn)\n`;
        response += `‚Ä¢ LISS: 2-3x per week (recovery cardio)\n`;
        response += `‚Ä¢ Total: 4-5 cardio sessions\n`;
      } else if (goal.toLowerCase().includes("muscle")) {
        response += `‚Ä¢ LISS: 2-3x per week (preserve muscle)\n`;
        response += `‚Ä¢ Avoid excessive cardio\n`;
        response += `‚Ä¢ Focus on strength training\n`;
      } else {
        response += `‚Ä¢ Mix of HIIT and MISS\n`;
        response += `‚Ä¢ 3-4x per week\n`;
        response += `‚Ä¢ Balance with strength training\n`;
      }
      
      response += `\n**üí° Today's Activity:**\n`;
      response += `‚Ä¢ Steps: ${steps.toLocaleString()}/10,000\n`;
      response += `‚Ä¢ Active minutes: ${activeMinutes}/60\n\n`;
      
      response += `Ready for a cardio session? Ask me for a specific workout!`;
      
      return response;
    }
    
    // Form/Technique inquiry
    if (lower.includes("form") || lower.includes("technique") || lower.includes("how to") || lower.includes("correct way")) {
      let response = `Great question about form, ${name}! Proper technique is crucial! üéØ\n\n`;
      
      response += `**üèãÔ∏è Key Exercise Form Tips:**\n\n`;
      response += `**Squats:**\n`;
      response += `‚úì Feet shoulder-width apart\n`;
      response += `‚úì Chest up, core tight\n`;
      response += `‚úì Knees track over toes\n`;
      response += `‚úì Depth: Thighs parallel to ground\n`;
      response += `‚úì Push through heels\n\n`;
      
      response += `**Push-ups:**\n`;
      response += `‚úì Hands shoulder-width\n`;
      response += `‚úì Body in straight line\n`;
      response += `‚úì Core engaged\n`;
      response += `‚úì Lower chest to ground\n`;
      response += `‚úì Elbows at 45¬∞ angle\n\n`;
      
      response += `**Deadlifts:**\n`;
      response += `‚úì Feet hip-width apart\n`;
      response += `‚úì Grip just outside legs\n`;
      response += `‚úì Back flat, chest up\n`;
      response += `‚úì Drive through heels\n`;
      response += `‚úì Hips and shoulders rise together\n\n`;
      
      response += `**Planks:**\n`;
      response += `‚úì Forearms on ground\n`;
      response += `‚úì Body in straight line\n`;
      response += `‚úì Don't let hips sag\n`;
      response += `‚úì Engage core and glutes\n`;
      response += `‚úì Breathe normally\n\n`;
      
      response += `**üéØ General Form Principles:**\n`;
      response += `‚Ä¢ Control the movement (no momentum)\n`;
      response += `‚Ä¢ Full range of motion\n`;
      response += `‚Ä¢ Breathe: Exhale on effort\n`;
      response += `‚Ä¢ Start light, master form first\n`;
      response += `‚Ä¢ Film yourself to check\n\n`;
      
      response += `üí° **Remember:** Perfect form > Heavy weight!`;
      
      return response;
    }
    
    // Time/Schedule inquiry
    if (lower.includes("when") || lower.includes("time") || lower.includes("schedule") || lower.includes("best time")) {
      let response = `Let's optimize your schedule, ${name}! ‚è∞\n\n`;
      
      response += `**üïê Best Times to Workout:**\n\n`;
      response += `**Morning (6-9 AM):**\n`;
      response += `‚úì Boosts metabolism all day\n`;
      response += `‚úì Consistent routine\n`;
      response += `‚úì Less crowded gyms\n`;
      response += `‚úì Better for fat burning (fasted)\n`;
      response += `‚ö†Ô∏è Need good warm-up\n\n`;
      
      response += `**Afternoon (2-4 PM):**\n`;
      response += `‚úì Peak body temperature\n`;
      response += `‚úì Best strength performance\n`;
      response += `‚úì Reduced injury risk\n`;
      response += `‚úì Optimal muscle function\n\n`;
      
      response += `**Evening (5-7 PM):**\n`;
      response += `‚úì Highest testosterone levels\n`;
      response += `‚úì Most people's preference\n`;
      response += `‚úì Stress relief after work\n`;
      response += `‚ö†Ô∏è May affect sleep if too late\n\n`;
      
      response += `**üìÖ Weekly Schedule Template:**\n`;
      response += `‚Ä¢ Monday: Upper body strength\n`;
      response += `‚Ä¢ Tuesday: Cardio/HIIT\n`;
      response += `‚Ä¢ Wednesday: Lower body strength\n`;
      response += `‚Ä¢ Thursday: Active recovery/yoga\n`;
      response += `‚Ä¢ Friday: Full body circuit\n`;
      response += `‚Ä¢ Saturday: Cardio + core\n`;
      response += `‚Ä¢ Sunday: Rest\n\n`;
      
      response += `**‚è∞ Meal Timing:**\n`;
      response += `‚Ä¢ Pre-workout: 1-2 hours before (carbs + protein)\n`;
      response += `‚Ä¢ Post-workout: Within 2 hours (protein + carbs)\n`;
      response += `‚Ä¢ Breakfast: Within 1 hour of waking\n`;
      response += `‚Ä¢ Dinner: 2-3 hours before bed\n\n`;
      
      response += `üí° **Best time = When you'll be most consistent!**`;
      
      return response;
    }
    
    // Default intelligent response with context awareness
    let response = `Hey ${name}! üëã\n\n`;
    
    // Analyze their question for keywords
    const keywords = lower.split(' ').filter(word => word.length > 3);
    const fitnessKeywords = ['fitness', 'health', 'body', 'weight', 'muscle', 'strength', 'endurance'];
    const hasFitnessContext = keywords.some(word => fitnessKeywords.includes(word));
    
    if (steps > 0 || workouts > 0 || hydration > 0) {
      response += `I can see you're active today:\n`;
      if (steps > 0) response += `‚Ä¢ ${steps.toLocaleString()} steps `;
      if (steps >= 10000) response += `‚úÖ\n`;
      else if (steps > 0) response += `(${(10000 - steps).toLocaleString()} to goal)\n`;
      if (workouts > 0) response += `‚Ä¢ ${workouts} workout${workouts > 1 ? 's' : ''} completed üí™\n`;
      if (activeMinutes > 0) response += `‚Ä¢ ${activeMinutes} active minutes\n`;
      if (hydration > 0) response += `‚Ä¢ ${hydration}/8 glasses of water üíß\n`;
      response += `\nKeep up the great work! üî•\n\n`;
    }
    
    if (hasFitnessContext) {
      response += `I'd love to help with that! Could you be more specific?\n\n`;
    }
    
    response += `**üí° I'm your AI fitness coach. I can help with:**\n\n`;
    response += `üèãÔ∏è **Workouts**\n`;
    response += `‚Ä¢ Custom workout plans\n`;
    response += `‚Ä¢ Exercise form and technique\n`;
    response += `‚Ä¢ HIIT, strength, cardio routines\n`;
    response += `‚Ä¢ Home or gym workouts\n\n`;
    
    response += `ü•ó **Nutrition**\n`;
    response += `‚Ä¢ Personalized meal plans\n`;
    response += `‚Ä¢ Calorie and macro calculations\n`;
    response += `‚Ä¢ Healthy recipes and food swaps\n`;
    response += `‚Ä¢ Supplement advice\n\n`;
    
    response += `üìä **Progress & Goals**\n`;
    response += `‚Ä¢ Track your daily stats\n`;
    response += `‚Ä¢ Set SMART fitness goals\n`;
    response += `‚Ä¢ Analyze your progress\n`;
    response += `‚Ä¢ Celebrate achievements\n\n`;
    
    response += `üí™ **Support**\n`;
    response += `‚Ä¢ Motivation and accountability\n`;
    response += `‚Ä¢ Injury prevention tips\n`;
    response += `‚Ä¢ Recovery and sleep advice\n`;
    response += `‚Ä¢ Answer any fitness question\n\n`;
    
    response += `**üéØ Quick Examples:**\n`;
    response += `‚Ä¢ "Create a workout plan for me"\n`;
    response += `‚Ä¢ "What should I eat today?"\n`;
    response += `‚Ä¢ "How many steps did I take?"\n`;
    response += `‚Ä¢ "Help me lose weight"\n`;
    response += `‚Ä¢ "I need motivation"\n`;
    response += `‚Ä¢ "Best time to workout?"\n\n`;
    
    response += `What would you like to know? I'm here to help! üí™`;
    
    return response;
  };

  const handleQuickPrompt = (prompt: string) => {
    setInput(prompt);
    inputRef.current?.focus();
  };

  const onKeyDown: React.KeyboardEventHandler<HTMLInputElement> = (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  };

  const clearChat = () => {
    setMessages([]);
    setError("");
  };

  const formatTime = (date: Date) => {
    return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
  };

  return (
    <div className="ai-coach-page">
      {/* Navigation */}
      <nav className="navbar">
        <div className="container">
          <div className="nav-wrapper">
            <Link to="/landing" className="brand-logo">
              <FitFusionLogo width={40} height={40} />
              <span className="brand-text">Fit Fusion</span>
            </Link>
            
            <ul className="nav-menu">
              <li><Link to="/dashboard" className="nav-link">Dashboard</Link></li>
              <li><Link to="/workout" className="nav-link">Workouts</Link></li>
              <li><Link to="/diet" className="nav-link">Nutrition</Link></li>
              <li><Link to="/progress" className="nav-link">Progress</Link></li>
              <li><Link to="/ai-coach" className="nav-link active">AI Coach</Link></li>
              <li className="nav-profile">
                <div className="profile-avatar">
                  <span>{userName.charAt(0) || 'U'}</span>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      {/* Main Content */}
      <div className="coach-container">
        <div className="container">
          {/* Header */}
          <div className="coach-header">
            <div className="header-content">
              <div className="coach-avatar">
                <span className="avatar-icon">ü§ñ</span>
              </div>
              <div className="header-text">
                <h1 className="coach-title">AI Fitness Coach</h1>
                <p className="coach-subtitle">
                  Your personal AI-powered fitness and nutrition expert, available 24/7
                </p>
              </div>
            </div>
            {messages.length > 0 && (
              <button className="clear-btn" onClick={clearChat}>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
                Clear Chat
              </button>
            )}
          </div>

          {/* Chat Interface */}
          <div className="chat-wrapper">
            <div className="chat-container">
              {messages.length === 0 ? (
                <div className="welcome-screen">
                  <div className="welcome-icon">üí™</div>
                  <h2 className="welcome-title">Welcome to Your AI Coach!</h2>
                  <p className="welcome-text">
                    I'm here to help you achieve your fitness goals. Ask me anything about:
                  </p>
                  <div className="features-grid">
                    <div className="feature-item">
                      <span className="feature-icon">üèãÔ∏è</span>
                      <span className="feature-text">Workout Plans</span>
                    </div>
                    <div className="feature-item">
                      <span className="feature-icon">ü•ó</span>
                      <span className="feature-text">Nutrition Advice</span>
                    </div>
                    <div className="feature-item">
                      <span className="feature-icon">üéØ</span>
                      <span className="feature-text">Goal Setting</span>
                    </div>
                    <div className="feature-item">
                      <span className="feature-icon">üìä</span>
                      <span className="feature-text">Progress Tracking</span>
                    </div>
                  </div>
                  
                  <div className="quick-prompts">
                    <p className="prompts-label">Quick Start:</p>
                    <div className="prompts-grid">
                      {quickPrompts.map((prompt, idx) => (
                        <button
                          key={idx}
                          className="prompt-btn"
                          onClick={() => handleQuickPrompt(prompt.prompt)}
                        >
                          <span className="prompt-icon">{prompt.icon}</span>
                          <span className="prompt-title">{prompt.title}</span>
                        </button>
                      ))}
                    </div>
                  </div>
                </div>
              ) : (
                <div className="messages-container">
                  {messages.filter(m => m.role !== 'system').map((m, idx) => (
                    <div key={idx} className={`message ${m.role}`}>
                      <div className="message-avatar">
                        {m.role === 'user' ? (
                          <span>{userName.charAt(0) || 'U'}</span>
                        ) : (
                          <span>ü§ñ</span>
                        )}
                      </div>
                      <div className="message-content">
                        <div className="message-header">
                          <span className="message-author">
                            {m.role === 'user' ? (userName || 'You') : 'AI Coach'}
                          </span>
                          <span className="message-time">{formatTime(m.timestamp)}</span>
                        </div>
                        <div className="message-text">{m.content}</div>
                      </div>
                    </div>
                  ))}
                  {thinking && (
                    <div className="message assistant">
                      <div className="message-avatar">
                        <span>ü§ñ</span>
                      </div>
                      <div className="message-content">
                        <div className="message-header">
                          <span className="message-author">AI Coach</span>
                        </div>
                        <div className="thinking-container">
                          <div className="thinking-logo">
                            <FitFusionLogo width={60} height={60} />
                          </div>
                          <div className="thinking-text">Thinking...</div>
                        </div>
                      </div>
                    </div>
                  )}
                  {loading && !thinking && (
                    <div className="message assistant">
                      <div className="message-avatar">
                        <span>ü§ñ</span>
                      </div>
                      <div className="message-content">
                        <div className="message-header">
                          <span className="message-author">AI Coach</span>
                        </div>
                        <div className="typing-indicator">
                          <span></span>
                          <span></span>
                          <span></span>
                        </div>
                      </div>
                    </div>
                  )}
                  <div ref={messagesEndRef} />
                </div>
              )}
            </div>

            {/* Input Area */}
            <div className="input-container">
              {error && (
                <div className="error-banner">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                  </svg>
                  <span>{error}</span>
                  <button onClick={() => setError('')}>√ó</button>
                </div>
              )}
              <div className="input-wrapper">
                <input
                  ref={inputRef}
                  type="text"
                  value={input}
                  onChange={(e) => setInput(e.target.value)}
                  onKeyDown={onKeyDown}
                  placeholder="Ask me anything about fitness, nutrition, or wellness..."
                  className="message-input"
                  disabled={loading || thinking}
                />
                <button 
                  className="send-btn" 
                  onClick={() => sendMessage()} 
                  disabled={loading || thinking || !input.trim()}
                >
                  {(loading || thinking) ? (
                    <svg className="spinner" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <circle cx="12" cy="12" r="10"/>
                    </svg>
                  ) : (
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                  )}
                </button>
              </div>
              <p className="input-hint">
                üí° Tip: Be specific about your goals, current fitness level, and any limitations for better advice
              </p>
            </div>
          </div>
        </div>
      </div>

      <style>{`
        .ai-coach-page {
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          background: #f8fafc;
          min-height: 100vh;
        }

        /* Navigation */
        .navbar {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(20px);
          border-bottom: 1px solid rgba(0, 0, 0, 0.08);
          position: sticky;
          top: 0;
          z-index: 1000;
        }

        .nav-wrapper {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 1rem 0;
        }

        .brand-logo {
          display: flex;
          align-items: center;
          gap: 0.75rem;
          text-decoration: none;
          color: #1a1a1a;
        }

        .logo-icon {
          width: 40px;
          height: 40px;
          background: linear-gradient(135deg, #708d50, #5a7340);
          border-radius: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
        }

        .brand-text {
          font-size: 1.5rem;
          font-weight: 800;
          letter-spacing: -0.5px;
        }

        .nav-menu {
          display: flex;
          align-items: center;
          gap: 0;
          list-style: none;
          margin: 0;
          padding: 0;
        }

        .nav-link {
          text-decoration: none;
          color: #4a4a4a;
          font-weight: 500;
          font-size: 0.95rem;
          padding: 0.75rem 1.25rem;
          border-radius: 8px;
          transition: all 0.3s ease;
        }

        .nav-link.active {
          color: #708d50;
          background: rgba(112, 141, 80, 0.1);
        }

        .nav-link:hover {
          color: #708d50;
          background: rgba(112, 141, 80, 0.08);
        }

        .nav-profile {
          margin-left: 1rem;
        }

        .profile-avatar {
          width: 40px;
          height: 40px;
          background: linear-gradient(135deg, #708d50, #5a7340);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: 700;
          cursor: pointer;
        }

        /* Coach Container */
        .coach-container {
          padding: 2rem 0;
          max-width: 1200px;
          margin: 0 auto;
        }

        .coach-header {
          background: white;
          border-radius: 20px;
          padding: 2rem;
          margin-bottom: 2rem;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .header-content {
          display: flex;
          align-items: center;
          gap: 1.5rem;
        }

        .coach-avatar {
          width: 80px;
          height: 80px;
          background: linear-gradient(135deg, #8aa665, #708d50);
          border-radius: 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 2.5rem;
        }

        .coach-title {
          font-size: 2rem;
          font-weight: 800;
          color: #1a1a1a;
          margin-bottom: 0.5rem;
        }

        .coach-subtitle {
          font-size: 1.125rem;
          color: #6a6a6a;
          margin: 0;
        }

        .clear-btn {
          background: #ef4444;
          color: white;
          border: none;
          border-radius: 12px;
          padding: 0.75rem 1.5rem;
          font-size: 0.95rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 0.5rem;
          transition: all 0.3s ease;
        }

        .clear-btn:hover {
          background: #dc2626;
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        /* Chat Wrapper */
        .chat-wrapper {
          background: white;
          border-radius: 20px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
          overflow: hidden;
          display: flex;
          flex-direction: column;
          height: calc(100vh - 300px);
          min-height: 600px;
        }

        .chat-container {
          flex: 1;
          overflow-y: auto;
          padding: 2rem;
        }

        /* Welcome Screen */
        .welcome-screen {
          text-align: center;
          padding: 2rem;
          max-width: 800px;
          margin: 0 auto;
        }

        .welcome-icon {
          font-size: 4rem;
          margin-bottom: 1.5rem;
        }

        .welcome-title {
          font-size: 2rem;
          font-weight: 700;
          color: #1a1a1a;
          margin-bottom: 1rem;
        }

        .welcome-text {
          font-size: 1.125rem;
          color: #6a6a6a;
          margin-bottom: 2rem;
        }

        .features-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
          gap: 1rem;
          margin-bottom: 3rem;
        }

        .feature-item {
          background: #f8fafc;
          border-radius: 12px;
          padding: 1.5rem;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 0.75rem;
        }

        .feature-icon {
          font-size: 2rem;
        }

        .feature-text {
          font-size: 0.95rem;
          font-weight: 600;
          color: #1a1a1a;
        }

        .quick-prompts {
          margin-top: 2rem;
        }

        .prompts-label {
          font-size: 1rem;
          font-weight: 600;
          color: #1a1a1a;
          margin-bottom: 1rem;
        }

        .prompts-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 1rem;
        }

        .prompt-btn {
          background: linear-gradient(135deg, #708d50, #5a7340);
          color: white;
          border: none;
          border-radius: 12px;
          padding: 1rem 1.5rem;
          font-size: 0.95rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 0.75rem;
          transition: all 0.3s ease;
        }

        .prompt-btn:hover {
          transform: translateY(-4px);
          box-shadow: 0 8px 20px rgba(112, 141, 80, 0.4);
        }

        .prompt-icon {
          font-size: 1.5rem;
        }

        /* Messages */
        .messages-container {
          display: flex;
          flex-direction: column;
          gap: 1.5rem;
        }

        .message {
          display: flex;
          gap: 1rem;
          animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
          from {
            opacity: 0;
            transform: translateY(10px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .message.user {
          flex-direction: row-reverse;
        }

        .message-avatar {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 700;
          flex-shrink: 0;
        }

        .message.user .message-avatar {
          background: linear-gradient(135deg, #708d50, #5a7340);
          color: white;
        }

        .message.assistant .message-avatar {
          background: linear-gradient(135deg, #8aa665, #708d50);
          font-size: 1.25rem;
        }

        .message-content {
          flex: 1;
          max-width: 70%;
        }

        .message.user .message-content {
          display: flex;
          flex-direction: column;
          align-items: flex-end;
        }

        .message-header {
          display: flex;
          align-items: center;
          gap: 0.75rem;
          margin-bottom: 0.5rem;
        }

        .message.user .message-header {
          flex-direction: row-reverse;
        }

        .message-author {
          font-size: 0.875rem;
          font-weight: 600;
          color: #1a1a1a;
        }

        .message-time {
          font-size: 0.75rem;
          color: #9ca3af;
        }

        .message-text {
          background: #f8fafc;
          padding: 1rem 1.25rem;
          border-radius: 16px;
          font-size: 0.95rem;
          line-height: 1.6;
          color: #1a1a1a;
          white-space: pre-wrap;
        }

        .message.user .message-text {
          background: linear-gradient(135deg, #708d50, #5a7340);
          color: white;
        }

        /* Thinking Animation */
        .thinking-container {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 1rem;
          padding: 2rem 3rem;
          background: linear-gradient(135deg, rgba(138, 166, 101, 0.1), rgba(112, 141, 80, 0.1));
          border-radius: 16px;
          width: fit-content;
        }

        .thinking-logo {
          animation: heartbeat 1.2s ease-in-out infinite;
          filter: drop-shadow(0 4px 12px rgba(112, 141, 80, 0.3));
        }

        @keyframes heartbeat {
          0%, 100% {
            transform: scale(1);
          }
          10%, 30% {
            transform: scale(1.1);
          }
          20%, 40% {
            transform: scale(1);
          }
          50% {
            transform: scale(1.15);
          }
          60% {
            transform: scale(1);
          }
        }

        .thinking-text {
          font-size: 1rem;
          font-weight: 600;
          color: #708d50;
          animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
          0%, 100% {
            opacity: 0.6;
          }
          50% {
            opacity: 1;
          }
        }

        /* Typing Indicator */
        .typing-indicator {
          display: flex;
          gap: 0.5rem;
          padding: 1rem 1.25rem;
          background: #f8fafc;
          border-radius: 16px;
          width: fit-content;
        }

        .typing-indicator span {
          width: 8px;
          height: 8px;
          background: #708d50;
          border-radius: 50%;
          animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) {
          animation-delay: -0.32s;
        }

        .typing-indicator span:nth-child(2) {
          animation-delay: -0.16s;
        }

        @keyframes bounce {
          0%, 80%, 100% {
            transform: scale(0);
          }
          40% {
            transform: scale(1);
          }
        }

        /* Input Container */
        .input-container {
          border-top: 1px solid #e5e7eb;
          padding: 1.5rem 2rem;
          background: #fafafa;
        }

        .error-banner {
          background: #fee2e2;
          border: 1px solid #ef4444;
          border-radius: 12px;
          padding: 0.75rem 1rem;
          margin-bottom: 1rem;
          display: flex;
          align-items: center;
          gap: 0.75rem;
          color: #dc2626;
          font-size: 0.875rem;
        }

        .error-banner button {
          margin-left: auto;
          background: none;
          border: none;
          color: #dc2626;
          font-size: 1.5rem;
          cursor: pointer;
          padding: 0;
          width: 24px;
          height: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .input-wrapper {
          display: flex;
          gap: 1rem;
          margin-bottom: 0.75rem;
        }

        .message-input {
          flex: 1;
          padding: 1rem 1.5rem;
          border: 2px solid #e5e7eb;
          border-radius: 12px;
          font-size: 0.95rem;
          font-family: inherit;
          transition: all 0.3s ease;
        }

        .message-input:focus {
          outline: none;
          border-color: #708d50;
          box-shadow: 0 0 0 3px rgba(112, 141, 80, 0.1);
        }

        .message-input:disabled {
          background: #f1f5f9;
          cursor: not-allowed;
        }

        .send-btn {
          background: linear-gradient(135deg, #708d50, #5a7340);
          color: white;
          border: none;
          border-radius: 12px;
          padding: 1rem 1.5rem;
          cursor: pointer;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .send-btn:hover:not(:disabled) {
          transform: translateY(-2px);
          box-shadow: 0 8px 20px rgba(112, 141, 80, 0.4);
        }

        .send-btn:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }

        .spinner {
          animation: spin 1s linear infinite;
        }

        @keyframes spin {
          from {
            transform: rotate(0deg);
          }
          to {
            transform: rotate(360deg);
          }
        }

        .input-hint {
          font-size: 0.875rem;
          color: #6a6a6a;
          margin: 0;
          display: flex;
          align-items: center;
          gap: 0.5rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
          .nav-menu {
            display: none;
          }

          .coach-header {
            flex-direction: column;
            gap: 1.5rem;
            text-align: center;
          }

          .header-content {
            flex-direction: column;
            text-align: center;
          }

          .coach-title {
            font-size: 1.5rem;
          }

          .chat-wrapper {
            height: calc(100vh - 400px);
          }

          .message-content {
            max-width: 85%;
          }

          .prompts-grid {
            grid-template-columns: 1fr;
          }
        }
      `}</style>
    </div>
  );
};

export default AiCoach;
